<!DOCTYPE html>
<html>
    <head>
        <title>Flourish API test</title>
        <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
        <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/d3-fetch@3"></script>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://cdn.flourish.rocks/flourish-live-v4.min.js"></script>
        <link href='http://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
        <style>
          body {
            font-family: Lato, sans-serif;
          }

          #chart {
            height: 70%;
          }

          button {
            background-color: #a6cee3; 
            border: none;
            border-radius: 0.3rem;
            color: white;
            padding: 10px 8px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 15px;
            margin: 4px 2px;
            transition-duration: 0.4s;
            cursor: pointer;
          }
        </style>
    </head>

    <body>
      <h2>Daily confirmed coronavirus cases by date reported</h2>
      <p>Select time period: 
        <button id="full-data">All</button>
        <button id="last-year">One year</button> 
        <button id="last-6-months">Last six months</button> 
        <button id="last-3-months">Last three months</button> 
        <button id="latest-month">Last month</button> 

      </p>
      
      <div id="chart"></div>



      <script>
          d3.csv("cases-England.csv").then(function(raw_data){
          var my_visualisation = new Flourish.Live({
            "template": "@flourish/line-bar-pie",
            "version": "22.1.0",
            "api_key": "FGCFFotq1s0aECvKcS6rilvdJBCgAHgG-jRUsR9uFznEbEodBBws9Niphbd3z93b",
            "container": "#chart",
            "private": false,
            "height": "200%",
            "state": {
                "chart_type": "column_stacked_line",
                "color": {
                "categorical_palette": [
                    "#1f78b4",
                    "#a6cee3"
                ],
                "sequential_palette": "Custom",
                "sequential_custom_min": "#e0e7f0",
                "sequential_custom_max": "#0d7faf",
                "diverging_palette": "Custom",
                "diverging_custom_min": "#df070a",
                "diverging_custom_max": "#15be09",
                },
                "column_opacity": 1,
                "column_padding_inner": 20,
                "column_padding_stack": 0.3,
                "datetime_input_format": "%Y-%m-%d",
                "dot_mode": "off",
                "dot_radius": 0.01,
                "dot_radius_last": 100000,
                "dual_axis": false,
                "facet_layout": "single",
                "facets": {
                "title_color": null
                },
                "label_data_type": "auto",
                "layout": {
                "body_font": {
                    "name": "Lato",
                    "url": "https://fonts.googleapis.com/css?family=Lato:400,700"
                },
                "subtitle_font": {
                    "name": "Source Sans Pro",
                    "url": "https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700"
                },
                "border": {
                    "enabled": false,
                    "top": {
                    "width": 3,
                    "color": "#686868"
                    },
                    "right": {
                    "width": 0
                    },
                    "bottom": {
                    "width": 0
                    },
                    "left": {
                    "width": 0
                    }
                },
                "font_color": "#404040",
                "title_size": "custom",
                "title_size_custom": 1.5,
                "subtitle_size": "custom",
                "subtitle_size_custom": 1.25,
                "header_text_size": "custom",
                "header_text_size_custom": 1.1,
                "header_text_line_height": 1.15,
                "footer_text_size": 0.9,
                "source_name": "data.gov.uk",
                "source_url": "https://coronavirus.data.gov.uk/details/cases",
                "footer_logo_height": 2
                },
                "legend_categorical": {
                "order_override": "Daily cases by date reported\nSeven-day average",
                "swatch_width": 0.7,
                "swatch_height": 0.75,
                "swatch_radius": 2
                },
                "legend_show": "false",
                "line_width": 0.2,
                "number_format": {
                "advanced": true,
                "n_dec": 0,
                "strip_separator": false
                },
                "popup": {
                "is_custom": false,
                "style_popups": true
                },
                "stack_labels": false,
                "text_legend": "off",
                "x_axis_date_format": "%d-%b-%y",
                "x": {
                "datetime_max": "2021-10-25",
                "datetime_min": "2020-02-17",
                "flip": false,
                "show_scale_settings": false,
                "tick_label_styling": true,
                "tick_mode": "number",
                "tick_label_color": "#777777",
                "tick_label_angle": 0
                },
                "y": {
                "tick_label_styling": true,
                "tick_mode": "number",
                "tick_label_color": "#777777"
                },
                "legend_continuous": {
                "color_band_height": 3,
                "color_band_radius": 1
                },
                "legend_categorical_points": {
                "swatch_width": 0.7,
                "swatch_height": 0.75,
                "swatch_radius": 2
                },
                "legend_categorical_map": {
                "swatch_width": 0.7,
                "swatch_height": 0.75,
                "swatch_radius": 2
                },
                "legend_continuous_points": {
                "color_band_height": 3,
                "color_band_radius": 1
                },
                "legend_continuous_map": {
                "color_band_height": 3,
                "color_band_radius": 1
                }
            },
            "bindings": {
                "data": {
                "label": "date",
                "value": [
                    "Seven-day average",
                    "Daily cases by date reported"
                ],
                // "metadata": [
                //     "date", 
                //     "Seven-day average",
                //     "Daily cases by date reported"
                // ]
                }
            },
            "data": {
              data: raw_data
            },
});



// var flourish_api = new Flourish.Live(opts);

	/* As an example of dynamically updating data and state, this sets
	   up the 'Randomize!' button so that it picks 3 new random altitude
	   values and updates the state so that the y axis just includes
	   them. */

  // latest month
	document.getElementById("latest-month").addEventListener('click', function () {
    var d = new Date();
    var today = d.getFullYear()+'-'+(d.getMonth()+1)+'-'+(d.getDate()-1);
    var todayMinusOneMonth = d.getFullYear()+'-'+(d.getMonth())+'-'+(d.getDate()-1);
    // console.log(today);
    // console.log(todayMinusOneMonth);

    my_visualisation.update({
        state: {
          "x": {
            "datetime_max": today,
            "datetime_min": todayMinusOneMonth
          },
          "color": {
                "categorical_palette": [
                    "#1f78b4",
                    "#a6cee3"
                ],
          }
        }
    });
  })

  // last 3 months
  document.getElementById("last-3-months").addEventListener('click', function () {
    var d = new Date();
    var today = d.getFullYear()+'-'+(d.getMonth()+1)+'-'+(d.getDate()-1);
    var todayMinusThreeMonths = d.getFullYear()+'-'+(d.getMonth()-2)+'-'+(d.getDate()-1);
    // console.log(today);
    // console.log(todayMinusThreeMonths);

    my_visualisation.update({
        state: {
          "x": {
            "datetime_max": today,
            "datetime_min": todayMinusThreeMonths
          },
          "color": {
                "categorical_palette": [
                    "#1f78b4",
                    "#a6cee3"
                ],
          }
        }
    });
  }) 

  // last 6 months
  document.getElementById("last-6-months").addEventListener('click', function () {
    var d = new Date();
    var today = d.getFullYear()+'-'+(d.getMonth()+1)+'-'+(d.getDate()-1);
    var todayMinusSixMonths = d.getFullYear()+'-'+(d.getMonth()-5)+'-'+(d.getDate()-1);
    // console.log(today);
    // console.log(todayMinusSixMonths);

    my_visualisation.update({
        state: {
          "x": {
            "datetime_max": today,
            "datetime_min": todayMinusSixMonths
          },
          "color": {
                "categorical_palette": [
                    "#1f78b4",
                    "#a6cee3"
                ],
          }
        }
    });
  }) 

  // last year
  document.getElementById("last-year").addEventListener('click', function () {
    var d = new Date();
    var today = d.getFullYear()+'-'+(d.getMonth()+1)+'-'+(d.getDate()-1);
    var todayMinusOneYear = (d.getFullYear()-1)+'-'+(d.getMonth()+1)+'-'+(d.getDate()-1);
    // console.log(today);
    // console.log(todayMinusOneYear);

    my_visualisation.update({
        state: {
          "x": {
            "datetime_max": today,
            "datetime_min": todayMinusOneYear
          },
          "color": {
                "categorical_palette": [
                    "#1f78b4",
                    "#a6cee3"
                ],
          }
        }
    });
  })

  // all 
  document.getElementById("full-data").addEventListener('click', function () {
    var d = new Date();
    var today = d.getFullYear()+'-'+(d.getMonth()+1)+'-'+(d.getDate()-1);

    my_visualisation.update({
        state: {
          "x": {
            "datetime_max": today,
            "datetime_min": "2020-02-17"
          },
          "color": {
                "categorical_palette": [
                    "#1f78b4",
                    "#a6cee3"
                ],
          }
        }
    });
  })  


});
// function showAllData() {
//             my_visualisation.update({
//                 state: {
//                     "x": {
//                         "datetime_max": "2021-10-25",
//                         "datetime_min": "2020-01-31"
//                     }
//         }})},

//         function showLatestMonth() {
//             my_visualisation.update({
//                 state: {
//                     "x": {
//                         "datetime_max": "2021-10-25",
//                         "datetime_min": "2021-09-25"
//                     }
//         }})}

    //     setTimeout(function() {
    //         my_visualisation.update({
    //             state: {
    //                 "x": {
    //                     "datetime_max": "2021-10-25",
    //                     "datetime_min": "2021-09-25"
    //                 }
	// },}, 4000)});

      </script>

    </body>
</html>